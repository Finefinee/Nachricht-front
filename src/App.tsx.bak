import React from 'react';
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider } from './contexts/AuthContext';
import { ChatProvider } from './contexts/ChatContext';
import LoginPage from './pages/LoginPage';
import RegisterPage from './pages/RegisterPage';
import ChatPage from './pages/ChatPage';
import { useAuth } from './hooks/useAuth';
import './App.css';

// ë³´í˜¸ëœ ë¼ìš°íŠ¸ ì»´í¬ë„ŒíŠ¸ - ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì ë¦¬ë””ë ‰ì…˜
const ProtectedRoute: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { state } = useAuth();
  
  if (!state.isAuthenticated) {
    console.log('ğŸ”’ ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì - ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜');
    return <Navigate to="/login" />;
  }

  return <>{children}</>;
};

// ì´ë¯¸ ì¸ì¦ëœ ì‚¬ìš©ìëŠ” ì±„íŒ… í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
const PublicRoute: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { state } = useAuth();
  
  if (state.isAuthenticated) {
    console.log('ğŸ”“ ì´ë¯¸ ì¸ì¦ëœ ì‚¬ìš©ì - ì±„íŒ… í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜');
    return <Navigate to="/chat" />;
  }

  return <>{children}</>;
};
  
  // ë©”ì‹œì§€ ìˆ˜ì‹  í•¸ë“¤ëŸ¬ - currentRoomIdê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ìƒˆë¡œ ìƒì„±
  const handleMessageReceived = useCallback((message: SendMessageRequest) => {
    console.log('ğŸ“¨ ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìˆ˜ì‹ :', message, 'í˜„ì¬ ë°©:', currentRoomId);
    
    // SendMessageRequestë¥¼ MessageEntityë¡œ ë³€í™˜
    const messageEntity: MessageEntity = {
      id: Date.now(),
      sender: {
        username: message.senderUsername,
        role: 'USER'
      },
      room: {
        id: message.roomId,
        participants: []
      },
      content: message.content,
      sentAt: message.when
    };
    
    // í˜„ì¬ ë³´ê³  ìˆëŠ” ì±„íŒ…ë°©ì´ë¼ë©´ ë©”ì‹œì§€ë¥¼ ì¶”ê°€
    if (message.roomId === currentRoomId) {
      setMessages(prev => [...prev, messageEntity]);
    } else {
      console.log(`ğŸ“© ë‹¤ë¥¸ ë°©(${message.roomId})ì— ìƒˆ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.`);
      // TODO: ë‚˜ì¤‘ì— ì•Œë¦¼ ì‹œìŠ¤í…œ ì¶”ê°€ ê°€ëŠ¥
    }
  }, [currentRoomId]);
  
  useEffect(() => {
    const initializeApp = async () => {
      try {
        // ì´ˆê¸°í™” ì‹œì‘ í‘œì‹œ
        setIsInitializing(true);
        setError('');
        
        // ê¸°ì¡´ í† í° í™•ì¸
        const token = localStorage.getItem('accessToken');
        const savedUser = localStorage.getItem('currentUser');
        
        console.log('ğŸ”„ ì•± ì´ˆê¸°í™” ì‹œì‘ - í† í°:', token ? 'ì¡´ì¬' : 'ì—†ìŒ', 'ì‚¬ìš©ì:', savedUser);
        
        if (!token || !savedUser) {
          console.log('ğŸ”“ í† í° ì—†ìŒ - ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ');
          setIsInitializing(false);
          return;
        }
        
        // ì‚¬ìš©ì ìƒíƒœ ì„¤ì • (ì¦‰ì‹œ ì‹¤í–‰)
        setUser(savedUser);
        setCurrentPage('chat');
        
        // ìˆœì°¨ì ìœ¼ë¡œ ëª¨ë“  ë°ì´í„° ë¡œë“œ (ì¤‘ê°„ì— ì‹¤íŒ¨í•´ë„ ì§„í–‰)
        try {
          console.log('ğŸ“‚ ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ ì‹œì‘...');
          
          // ì±„íŒ…ë°© ë¡œë“œ (ìµœëŒ€ 3íšŒ ì¬ì‹œë„)
          let userRooms: MessengerRoom[] = [];
          let retryCount = 0;
          const maxRetries = 3;
          
          while (retryCount < maxRetries) {
            try {
              userRooms = await roomAPI.getUserRooms(savedUser);
              console.log('ğŸ“‚ ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ ì„±ê³µ:', userRooms.length, 'ê°œ ì±„íŒ…ë°©');
              break; // ì„±ê³µí•˜ë©´ ë£¨í”„ ì¢…ë£Œ
            } catch (roomError) {
              retryCount++;
              console.error(`ì±„íŒ…ë°© ë¡œë“œ ì‹¤íŒ¨ (ì‹œë„ ${retryCount}/${maxRetries}):`, roomError);
              if (retryCount >= maxRetries) throw roomError;
              await new Promise(r => setTimeout(r, 1000)); // 1ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„
            }
          }
          
          // ì±„íŒ…ë°© ëª©ë¡ ìƒíƒœ ì—…ë°ì´íŠ¸
          setRooms(userRooms);
          
          // ì²« ë²ˆì§¸ ì±„íŒ…ë°© ë©”ì‹œì§€ ë¡œë“œ (ì±„íŒ…ë°©ì´ ìˆì„ ê²½ìš°)
          if (userRooms.length > 0) {
            const firstRoomId = userRooms[0].id;
            setCurrentRoomId(firstRoomId);
            console.log('ğŸ“¨ ì²« ë²ˆì§¸ ì±„íŒ…ë°© ë©”ì‹œì§€ ë¡œë“œ ì‹œì‘:', firstRoomId);
            
            try {
              const roomMessages = await messageAPI.getMessages(firstRoomId);
              console.log('ğŸ“¨ ë©”ì‹œì§€ ë¡œë“œ ì„±ê³µ:', roomMessages.length, 'ê°œ ë©”ì‹œì§€');
              setMessages(roomMessages);
            } catch (msgError) {
              console.error('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', msgError);
              setMessages([]); // ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
            }
          } else {
            console.log('ğŸ“‚ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.');
            setMessages([]);
          }
          
          // WebSocket ì—°ê²° (ëª…ì‹œì ìœ¼ë¡œ ê¸°ë‹¤ë¦¼)
          console.log('ğŸ”Œ WebSocket ì—°ê²° ì‹œì‘...');
          try {
            await webSocketService.connect(savedUser);
            console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ');
            
            // ë¶„ë¦¬ëœ ë©”ì‹œì§€ ìˆ˜ì‹  í•¸ë“¤ëŸ¬ ì„¤ì •
            webSocketService.onMessage(handleMessageReceived);
          } catch (wsError) {
            console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', wsError);
            // WebSocket ì‹¤íŒ¨ëŠ” ì¹˜ëª…ì  ì˜¤ë¥˜ê°€ ì•„ë‹ˆë¯€ë¡œ ê³„ì† ì§„í–‰
            setError('ì‹¤ì‹œê°„ ë©”ì‹œì§• ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë©”ì‹œì§€ ì „ì†¡ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          }
        } catch (error) {
          console.error('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
          setError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•´ë³´ì„¸ìš”.');
        } finally {
          // ëª¨ë“  ì‘ì—… ì™„ë£Œ í›„ ì´ˆê¸°í™” ìƒíƒœ í•´ì œ
          setIsInitializing(false);
          console.log('âœ… ì•± ì´ˆê¸°í™” ì™„ë£Œ');
        }
      } catch (criticalError) {
        console.error('ğŸ’¥ ì¹˜ëª…ì  ì˜¤ë¥˜:', criticalError);
        setError('ì•± ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        setIsInitializing(false);
      }
    };

    initializeApp();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // ì‚¬ìš©ì ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
  const loadUserRooms = async () => {
    try {
      if (user) {
        console.log('ğŸ”„ ì±„íŒ…ë°© ëª©ë¡ ì¬ë¡œë“œ ì‹œì‘...');
        const userRooms = await roomAPI.getUserRooms(user);
        console.log('ğŸ”„ ì±„íŒ…ë°© ëª©ë¡ ì¬ë¡œë“œ ì„±ê³µ:', userRooms);
        setRooms(userRooms);
        
        if (userRooms.length > 0) {
          // í˜„ì¬ ì„ íƒëœ ë°©ì´ ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ë°© ì„ íƒ
          const roomToSelect = currentRoomId && userRooms.find(r => r.id === currentRoomId)
            ? currentRoomId 
            : userRooms[0].id;
            
          setCurrentRoomId(roomToSelect);
          // ë©”ì‹œì§€ ë¡œë”©ì„ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬
          await loadMessages(roomToSelect);
        } else {
          setCurrentRoomId(null);
          setMessages([]);
        }
      }
    } catch (error) {
      console.error('ì±„íŒ…ë°© ë¡œë“œ ì‹¤íŒ¨:', error);
      setError('ì±„íŒ…ë°©ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  };

  // ë©”ì‹œì§€ ë¡œë“œ
  const loadMessages = async (roomId: number, retryCount = 0) => {
    try {
      console.log('ğŸ“¨ ë©”ì‹œì§€ ë¡œë“œ ì‹œì‘ - ì±„íŒ…ë°© ID:', roomId);
      
      // ë¡œë”© ìƒíƒœ í‘œì‹œ
      setIsLoading(true);
      
      const roomMessages = await messageAPI.getMessages(roomId);
      console.log('ğŸ“¨ ë©”ì‹œì§€ ë¡œë“œ ì„±ê³µ:', roomMessages.length, 'ê°œ ë©”ì‹œì§€');
      
      // ì •ìƒ ë©”ì‹œì§€ ë°°ì—´ë¡œ ì„¤ì • ë° ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”
      setMessages(roomMessages);
      
      if (roomMessages.length === 0) {
        console.log('â„¹ï¸ ì±„íŒ…ë°©ì— ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
      }
      
      // ì—ëŸ¬ê°€ ìˆì—ˆë‹¤ë©´ ì´ˆê¸°í™”
      if (error) setError('');
      
    } catch (err) {
      console.error('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', err);
      
      // ìµœëŒ€ 2ë²ˆê¹Œì§€ ì¬ì‹œë„
      if (retryCount < 2) {
        console.log(`ğŸ”„ ë©”ì‹œì§€ ë¡œë“œ ì¬ì‹œë„ ${retryCount + 1}/2...`);
        setTimeout(() => loadMessages(roomId, retryCount + 1), 1000);
        return;
      }
      
      // ì‹¤íŒ¨ ì‹œ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”í•˜ê³  ì—ëŸ¬ ë©”ì‹œì§€ ì„¤ì •
      setMessages([]);
      setError('ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•´ë³´ì„¸ìš”.');
      
    } finally {
      setIsLoading(false);
    }
  };

  // ìƒˆ ì±„íŒ…ë°© ìƒì„±
  const handleCreateRoom = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!newRoomParticipant.trim() || !user) return;

    const participants = [user, newRoomParticipant.trim()];
    console.log('ì±„íŒ…ë°© ìƒì„± ìš”ì²­:', { participants });

    try {
      const response = await roomAPI.createRoom(participants);
      
      console.log('ì±„íŒ…ë°© ìƒì„± ì„±ê³µ:', response);
      
      setNewRoomParticipant('');
      setShowCreateRoom(false);
      setError(''); // ì„±ê³µ ì‹œ ê¸°ì¡´ ì—ëŸ¬ ë©”ì‹œì§€ ì œê±°
      
      // ì±„íŒ…ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      await loadUserRooms();
    } catch (error) {
      console.error('ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨:', error);
      
      // ìƒì„¸í•œ ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
      if (error && typeof error === 'object' && 'response' in error) {
        const axiosError = error as { response: { status: number; data?: { message?: string }; statusText: string } };
        const status = axiosError.response.status;
        const message = axiosError.response.data?.message || axiosError.response.statusText;
        
        if (status === 403) {
          setError('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        } else if (status === 404) {
          setError('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤. ì‚¬ìš©ìëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        } else if (status === 400) {
          setError('ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤. ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        } else {
          setError(`ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ${message} (${status})`);
        }
      } else if (error instanceof Error) {
        setError(`ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ${error.message}`);
      } else {
        setError('ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      }
    }
  };

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    
    if (!username || !password) {
      setError('ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    try {
      const response = await authAPI.login({ username, password });
      
      // í† í° ì €ì¥
      localStorage.setItem('accessToken', response.accessToken);
      localStorage.setItem('refreshToken', response.refreshToken);
      localStorage.setItem('currentUser', username);
      
      setUser(username);
      setCurrentPage('chat');
      
      // ì‚¬ìš©ì ì±„íŒ…ë°© ë¡œë“œ (ë¨¼ì € ì‹¤í–‰)
      await loadUserRooms();
      
      // WebSocket ì—°ê²° (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¹„ë™ê¸° ì‹¤í–‰)
      webSocketService.connect(username)
        .then(() => {
          console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ');
          
          // ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìˆ˜ì‹  í•¸ë“¤ëŸ¬ ì„¤ì •
          webSocketService.onMessage((message) => {
            console.log('ğŸ“¨ ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìˆ˜ì‹ :', message, 'í˜„ì¬ ë°©:', currentRoomId);
            
            // SendMessageRequestë¥¼ MessageEntityë¡œ ë³€í™˜
            const messageEntity: MessageEntity = {
              id: Date.now(),
              sender: {
                username: message.senderUsername,
                role: 'USER'
              },
              room: {
                id: message.roomId,
                participants: []
              },
              content: message.content,
              sentAt: message.when
            };
            
            // í˜„ì¬ ë³´ê³  ìˆëŠ” ì±„íŒ…ë°©ì´ë¼ë©´ ë©”ì‹œì§€ë¥¼ ì¶”ê°€
            if (currentRoomId === message.roomId) {
              setMessages(prev => [...prev, messageEntity]);
            } else {
              // ë‹¤ë¥¸ ë°©ì˜ ë©”ì‹œì§€ì¸ ê²½ìš° ì•Œë¦¼ë§Œ í‘œì‹œ
              console.log(`ğŸ“© ë‹¤ë¥¸ ë°©(${message.roomId})ì— ìƒˆ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.`);
              // TODO: ë‚˜ì¤‘ì— ì•Œë¦¼ ì‹œìŠ¤í…œ ì¶”ê°€ ê°€ëŠ¥
            }
          });
        })
        .catch((wsError) => {
          console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', wsError);
          setError('ì‹¤ì‹œê°„ ë©”ì‹œì§• ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë©”ì‹œì§€ ì „ì†¡ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        });
    } catch (error) {
      console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
      setError('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
    }
  };

  const handleRegister = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    
    if (!username || !password || !confirmPassword) {
      setError('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    if (password !== confirmPassword) {
      setError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      return;
    }

    if (password.length < 4) {
      setError('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
      return;
    }

    try {
      await authAPI.register({ username, password });
      
      // íšŒì›ê°€ì… í›„ ìë™ ë¡œê·¸ì¸
      const response = await authAPI.login({ username, password });
      
      // í† í° ì €ì¥
      localStorage.setItem('accessToken', response.accessToken);
      localStorage.setItem('refreshToken', response.refreshToken);
      localStorage.setItem('currentUser', username);
      
      setUser(username);
      setCurrentPage('chat');
      
      // ì‚¬ìš©ì ì±„íŒ…ë°© ë¡œë“œ
      await loadUserRooms();
    } catch (error) {
      console.error('íšŒì›ê°€ì… ì‹¤íŒ¨:', error);
      setError('íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ìš©ìëª…ì„ ì‹œë„í•´ë³´ì„¸ìš”.');
    }
  };

  const handleSendMessage = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!newMessage.trim() || !currentRoomId || !user) return;

    const messageContent = newMessage.trim();
    setNewMessage(''); // ì…ë ¥ì°½ ì¦‰ì‹œ ë¹„ìš°ê¸°

    try {
      // WebSocket ì—°ê²° ìƒíƒœ í™•ì¸ ë° ì¬ì—°ê²° ì‹œë„
      if (!webSocketService.isConnected()) {
        console.warn('WebSocketì´ ì—°ê²°ë˜ì§€ ì•ŠìŒ. ì¬ì—°ê²° ì‹œë„...');
        try {
          await webSocketService.connect(user);
          console.log('âœ… WebSocket ì¬ì—°ê²° ì„±ê³µ');
        } catch (reconnectError) {
          console.error('WebSocket ì¬ì—°ê²° ì‹¤íŒ¨:', reconnectError);
          throw new Error('ì‹¤ì‹œê°„ ë©”ì‹œì§• ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }

      const now = new Date().toISOString();
      
      // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ ì¦‰ì‹œ í™”ë©´ì— í‘œì‹œ (ë‚™ê´€ì  UI ì—…ë°ì´íŠ¸)
      const tempId = Date.now();
      const myMessage: MessageEntity = {
        id: tempId,
        sender: {
          username: user,
          role: 'USER'
        },
        room: {
          id: currentRoomId,
          participants: []
        },
        content: messageContent,
        sentAt: now
      };
      
      setMessages(prev => [...prev, myMessage]);
      
      // ë©”ì‹œì§€ ê°ì²´ ìƒì„±
      const messageRequest = {
        senderUsername: user,
        roomId: currentRoomId,
        content: messageContent,
        when: now
      };
      
      // 1. WebSocketì„ í†µí•œ ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „ì†¡ (ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬)
      const webSocketPromise = webSocketService.sendMessage(messageRequest);
      
      // 2. REST APIë¥¼ í†µí•´ DBì— ë©”ì‹œì§€ ì €ì¥ (ë³‘ë ¬ë¡œ ì²˜ë¦¬)
      const savePromise = messageAPI.saveMessage(messageRequest)
        .then(savedMessage => {
          console.log('ğŸ’¾ DBì— ë©”ì‹œì§€ ì €ì¥ ì„±ê³µ:', savedMessage);
          // DBì—ì„œ ë°˜í™˜ëœ IDë¡œ ì„ì‹œ ë©”ì‹œì§€ ID ì—…ë°ì´íŠ¸
          setMessages(prev => 
            prev.map(msg => 
              msg.id === tempId ? { ...msg, id: savedMessage.id } : msg
            )
          );
          return savedMessage;
        });
      
      // ë‘ ì‘ì—… ëª¨ë‘ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
      await Promise.all([webSocketPromise, savePromise]);
      console.log('âœ… ë©”ì‹œì§€ ì „ì†¡ ë° ì €ì¥ ì™„ë£Œ');
      
    } catch (error) {
      console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
      setError('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error instanceof Error ? error.message : 'WebSocket ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'));
      // ë©”ì‹œì§€ ì „ì†¡ì´ ì‹¤íŒ¨í•˜ë©´ ì…ë ¥ì°½ì— ë©”ì‹œì§€ ë‚´ìš© ë³µì› (UX ê°œì„ )
      setNewMessage(messageContent);
    }
  };

  const logout = () => {
    // WebSocket ì—°ê²° í•´ì œ
    webSocketService.disconnect();
    
    localStorage.removeItem('accessToken');
    localStorage.removeItem('refreshToken');
    localStorage.removeItem('currentUser');
    
    setUser(null);
    setCurrentPage('login');
    setUsername('');
    setPassword('');
    setConfirmPassword('');
    setError('');
    setMessages([]);
    setRooms([]);
    setCurrentRoomId(null);
    setShowCreateRoom(false);
    setNewRoomParticipant('');
  };

  // ë¡œê·¸ì¸ í˜ì´ì§€
  if (currentPage === 'login') {
    return (
      <div style={{ 
        minHeight: '100vh', 
        backgroundColor: '#f0f0f0', 
        padding: '20px',
        fontFamily: 'Arial, sans-serif',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center'
      }}>
        <div style={{ 
          backgroundColor: 'white', 
          padding: '40px', 
          maxWidth: '400px',
          width: '100%',
          borderRadius: '12px',
          boxShadow: '0 4px 20px rgba(0,0,0,0.1)'
        }}>
          <h1 style={{ color: '#333', fontSize: '1.8rem', textAlign: 'center', marginBottom: '30px' }}>
            ğŸ’¬ Nachricht
          </h1>
          
          {error && (
            <div style={{
              backgroundColor: '#fee',
              color: '#c33',
              padding: '10px',
              borderRadius: '4px',
              marginBottom: '20px',
              fontSize: '14px'
            }}>
              {error}
            </div>
          )}

          <form onSubmit={handleLogin}>
            <div style={{ marginBottom: '20px' }}>
              <label style={{ display: 'block', marginBottom: '5px', color: '#555', fontSize: '14px' }}>
                ì‚¬ìš©ìëª…
              </label>
              <input 
                type="text" 
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”" 
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #ddd',
                  borderRadius: '6px',
                  fontSize: '16px',
                  outline: 'none',
                  boxSizing: 'border-box'
                }}
              />
            </div>
            <div style={{ marginBottom: '25px' }}>
              <label style={{ display: 'block', marginBottom: '5px', color: '#555', fontSize: '14px' }}>
                ë¹„ë°€ë²ˆí˜¸
              </label>
              <input 
                type="password" 
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #ddd',
                  borderRadius: '6px',
                  fontSize: '16px',
                  outline: 'none',
                  boxSizing: 'border-box'
                }}
              />
            </div>
            <button 
              type="submit"
              style={{
                width: '100%',
                padding: '14px',
                backgroundColor: '#007bff',
                color: 'white',
                border: 'none',
                borderRadius: '6px',
                fontSize: '16px',
                fontWeight: 'bold',
                cursor: 'pointer'
              }}
            >
              ë¡œê·¸ì¸
            </button>
          </form>
          <p style={{ textAlign: 'center', marginTop: '25px', color: '#666' }}>
            ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? 
            <button 
              onClick={() => setCurrentPage('register')}
              style={{ 
                color: '#007bff', 
                background: 'none', 
                border: 'none', 
                cursor: 'pointer',
                fontWeight: 'bold',
                textDecoration: 'underline'
              }}
            >
              íšŒì›ê°€ì…
            </button>
          </p>
        </div>
      </div>
    );
  }

  // íšŒì›ê°€ì… í˜ì´ì§€
  if (currentPage === 'register') {
    return (
      <div style={{ 
        minHeight: '100vh', 
        backgroundColor: '#f0f0f0', 
        padding: '20px',
        fontFamily: 'Arial, sans-serif',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center'
      }}>
        <div style={{ 
          backgroundColor: 'white', 
          padding: '40px', 
          maxWidth: '400px',
          width: '100%',
          borderRadius: '12px',
          boxShadow: '0 4px 20px rgba(0,0,0,0.1)'
        }}>
          <h1 style={{ color: '#333', fontSize: '1.8rem', textAlign: 'center', marginBottom: '30px' }}>
            ğŸ“ íšŒì›ê°€ì…
          </h1>
          
          {error && (
            <div style={{
              backgroundColor: '#fee',
              color: '#c33',
              padding: '10px',
              borderRadius: '4px',
              marginBottom: '20px',
              fontSize: '14px'
            }}>
              {error}
            </div>
          )}

          <form onSubmit={handleRegister}>
            <div style={{ marginBottom: '20px' }}>
              <label style={{ display: 'block', marginBottom: '5px', color: '#555', fontSize: '14px' }}>
                ì‚¬ìš©ìëª…
              </label>
              <input 
                type="text" 
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”" 
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #ddd',
                  borderRadius: '6px',
                  fontSize: '16px',
                  outline: 'none',
                  boxSizing: 'border-box'
                }}
              />
            </div>
            <div style={{ marginBottom: '20px' }}>
              <label style={{ display: 'block', marginBottom: '5px', color: '#555', fontSize: '14px' }}>
                ë¹„ë°€ë²ˆí˜¸
              </label>
              <input 
                type="password" 
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #ddd',
                  borderRadius: '6px',
                  fontSize: '16px',
                  outline: 'none',
                  boxSizing: 'border-box'
                }}
              />
            </div>
            <div style={{ marginBottom: '25px' }}>
              <label style={{ display: 'block', marginBottom: '5px', color: '#555', fontSize: '14px' }}>
                ë¹„ë°€ë²ˆí˜¸ í™•ì¸
              </label>
              <input 
                type="password" 
                value={confirmPassword}
                onChange={(e) => setConfirmPassword(e.target.value)}
                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”" 
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #ddd',
                  borderRadius: '6px',
                  fontSize: '16px',
                  outline: 'none',
                  boxSizing: 'border-box'
                }}
              />
            </div>
            <button 
              type="submit"
              style={{
                width: '100%',
                padding: '14px',
                backgroundColor: '#28a745',
                color: 'white',
                border: 'none',
                borderRadius: '6px',
                fontSize: '16px',
                fontWeight: 'bold',
                cursor: 'pointer'
              }}
            >
              íšŒì›ê°€ì…
            </button>
          </form>
          <p style={{ textAlign: 'center', marginTop: '25px', color: '#666' }}>
            ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? 
            <button 
              onClick={() => setCurrentPage('login')}
              style={{ 
                color: '#007bff', 
                background: 'none', 
                border: 'none', 
                cursor: 'pointer',
                fontWeight: 'bold',
                textDecoration: 'underline'
              }}
            >
              ë¡œê·¸ì¸
            </button>
          </p>
        </div>
      </div>
    );
  }

  // ì±„íŒ… í˜ì´ì§€
  return (
    <div style={{ 
      minHeight: '100vh', 
      backgroundColor: '#f8f9fa',
      fontFamily: 'Arial, sans-serif',
      display: 'flex',
      flexDirection: 'column',
      position: 'relative'
    }}>
      {isInitializing && (
        <div style={{
          position: 'absolute',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(255,255,255,0.95)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          flexDirection: 'column',
          zIndex: 1000
        }}>
          <div style={{ 
            width: '80px', 
            height: '80px', 
            border: '5px solid #f3f3f3',
            borderTop: '5px solid #3498db',
            borderRadius: '50%',
            animation: 'spin 1s linear infinite',
            marginBottom: '20px'
          }}></div>
          <style>{`
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
            @keyframes fadeIn {
              from { opacity: 0; }
              to { opacity: 1; }
            }
          `}</style>
          <h2 style={{ color: '#333', margin: '0 0 10px 0' }}>Nachricht ë¡œë”© ì¤‘...</h2>
          <p style={{ 
            color: '#666', 
            maxWidth: '80%', 
            textAlign: 'center',
            animation: 'fadeIn 0.5s ease-in-out',
            margin: '0 0 5px 0' 
          }}>
            ì±„íŒ…ë°© ë° ë©”ì‹œì§€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤
          </p>
          <p style={{ 
            color: '#999', 
            fontSize: '14px', 
            maxWidth: '70%', 
            textAlign: 'center',
            animation: 'fadeIn 1s ease-in-out',
            margin: '0'
          }}>
            ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...
          </p>
        </div>
      )}
      {/* í—¤ë” */}
      <div style={{
        backgroundColor: '#007bff',
        color: 'white',
        padding: '15px 20px',
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        boxShadow: '0 2px 10px rgba(0,0,0,0.1)'
      }}>
        <h1 style={{ margin: 0, fontSize: '1.5rem' }}>ğŸ’¬ Nachricht</h1>
        <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
          <span>ì•ˆë…•í•˜ì„¸ìš”, {user}ë‹˜!</span>
          <button 
            onClick={logout}
            style={{
              padding: '8px 16px',
              backgroundColor: 'rgba(255,255,255,0.2)',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: 'pointer'
            }}
          >
            ë¡œê·¸ì•„ì›ƒ
          </button>
        </div>
      </div>

      {/* ë©”ì¸ ì±„íŒ… ì˜ì—­ */}
      <div style={{ 
        flex: 1, 
        display: 'flex',
        maxHeight: 'calc(100vh - 70px)'
      }}>
        {/* ì±„íŒ…ë°© ëª©ë¡ */}
        <div style={{
          width: '300px',
          backgroundColor: 'white',
          borderRight: '1px solid #dee2e6',
          display: 'flex',
          flexDirection: 'column'
        }}>
          <div style={{
            padding: '20px',
            borderBottom: '1px solid #dee2e6',
            backgroundColor: '#f8f9fa'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <h3 style={{ margin: 0, color: '#333' }}>ì±„íŒ…ë°©</h3>
              <button
                onClick={() => setShowCreateRoom(!showCreateRoom)}
                style={{
                  padding: '6px 12px',
                  backgroundColor: '#007bff',
                  color: 'white',
                  border: 'none',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  fontSize: '14px'
                }}
              >
                {showCreateRoom ? 'ì·¨ì†Œ' : '+ ìƒˆ ì±„íŒ…'}
              </button>
            </div>
          </div>
          <div style={{ flex: 1, padding: '10px' }}>
            {/* ìƒˆ ì±„íŒ…ë°© ìƒì„± í¼ */}
            {showCreateRoom && (
              <div style={{
                padding: '15px',
                backgroundColor: '#e8f4f8',
                borderRadius: '8px',
                marginBottom: '15px',
                border: '2px solid #17a2b8'
              }}>
                <h4 style={{ margin: '0 0 10px 0', color: '#0c5460', fontSize: '16px' }}>ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</h4>
                <form onSubmit={handleCreateRoom}>
                  <input
                    type="text"
                    value={newRoomParticipant}
                    onChange={(e) => setNewRoomParticipant(e.target.value)}
                    placeholder="ëŒ€í™”í•  ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                    style={{
                      width: '100%',
                      padding: '8px',
                      border: '1px solid #17a2b8',
                      borderRadius: '4px',
                      fontSize: '14px',
                      marginBottom: '10px',
                      boxSizing: 'border-box'
                    }}
                  />
                  <button
                    type="submit"
                    style={{
                      width: '100%',
                      padding: '8px',
                      backgroundColor: '#17a2b8',
                      color: 'white',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontSize: '14px'
                    }}
                  >
                    ì±„íŒ…ë°© ìƒì„±
                  </button>
                </form>
              </div>
            )}

            {/* ê¸°ì¡´ ì±„íŒ…ë°© ëª©ë¡ */}
            {rooms.length > 0 ? (
              rooms.map((room) => (
                <div 
                  key={room.id}
                  onClick={async () => {
                    console.log('ğŸšª ì±„íŒ…ë°© ì„ íƒ:', room.id);
                    setCurrentRoomId(room.id);
                    
                    // ë©”ì‹œì§€ ë¡œë”©
                    await loadMessages(room.id);
                    
                    // WebSocket ì—°ê²° ìƒíƒœ í™•ì¸
                    if (user && !webSocketService.isConnected()) {
                      try {
                        console.log('ğŸ”Œ ì±„íŒ…ë°© ì„ íƒ ì‹œ WebSocket ì—°ê²° í™•ì¸ ë° ì¬ì—°ê²° ì‹œë„');
                        await webSocketService.connect(user);
                        console.log('âœ… WebSocket ì¬ì—°ê²° ì„±ê³µ');
                      } catch (error) {
                        console.error('âŒ WebSocket ì¬ì—°ê²° ì‹¤íŒ¨:', error);
                        setError('ì‹¤ì‹œê°„ ë©”ì‹œì§• ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•´ë³´ì„¸ìš”.');
                      }
                    }
                  }}
                  style={{
                    padding: '15px',
                    backgroundColor: currentRoomId === room.id ? '#e3f2fd' : '#f8f9fa',
                    borderRadius: '8px',
                    marginBottom: '10px',
                    cursor: 'pointer',
                    border: currentRoomId === room.id ? '2px solid #2196f3' : '1px solid #dee2e6'
                  }}
                >
                  <div style={{ fontWeight: 'bold', color: '#333' }}>
                    {room.participants
                      .filter(p => p.username !== user)
                      .map(p => p.username)
                      .join(', ') || 'ë‚˜ë§Œ ìˆëŠ” ë°©'}
                  </div>
                  <div style={{ fontSize: '14px', color: '#666', marginTop: '5px' }}>
                    ì±„íŒ…ë°© #{room.id}
                  </div>
                </div>
              ))
            ) : (
              <div style={{
                padding: '15px',
                backgroundColor: '#f8f9fa',
                borderRadius: '8px',
                textAlign: 'center',
                color: '#666'
              }}>
                ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤
              </div>
            )}
          </div>
        </div>

        {/* ë©”ì‹œì§€ ì˜ì—­ */}
        <div style={{ 
          flex: 1, 
          display: 'flex', 
          flexDirection: 'column',
          backgroundColor: 'white'
        }}>
          {/* ë©”ì‹œì§€ ëª©ë¡ */}
          <div style={{
            flex: 1,
            padding: '20px',
            overflowY: 'auto',
            backgroundColor: '#fafafa'
          }}>
            {isLoading ? (
              <div style={{ 
                textAlign: 'center', 
                padding: '30px', 
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                gap: '15px'
              }}>
                <div style={{ 
                  width: '40px', 
                  height: '40px', 
                  border: '3px solid #f0f0f0',
                  borderTop: '3px solid #3498db',
                  borderRadius: '50%',
                  animation: 'spin 1s linear infinite'
                }}></div>
                <div>
                  <div style={{ color: '#666', fontWeight: 'bold' }}>ë©”ì‹œì§€ ë¡œë”© ì¤‘...</div>
                  <div style={{ color: '#999', fontSize: '14px', marginTop: '5px' }}>ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤</div>
                </div>
              </div>
            ) : messages.length > 0 ? (
              messages.map((message) => (
              <div 
                key={message.id}
                style={{
                  marginBottom: '15px',
                  display: 'flex',
                  justifyContent: message.sender.username === user ? 'flex-end' : 'flex-start'
                }}
              >
                <div style={{
                  maxWidth: '70%',
                  padding: '12px 16px',
                  borderRadius: '18px',
                  backgroundColor: message.sender.username === user ? '#007bff' : 'white',
                  color: message.sender.username === user ? 'white' : '#333',
                  boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                }}>
                  {message.sender.username !== user && (
                    <div style={{ 
                      fontSize: '12px', 
                      opacity: 0.7, 
                      marginBottom: '4px',
                      fontWeight: 'bold'
                    }}>
                      {message.sender.username}
                    </div>
                  )}
                  <div>{message.content}</div>
                  <div style={{ 
                    fontSize: '11px', 
                    opacity: 0.6, 
                    marginTop: '4px',
                    textAlign: 'right'
                  }}>
                    {new Date(message.sentAt).toLocaleTimeString()}
                  </div>
                </div>
              </div>
            ))) : (
              <div style={{ 
                textAlign: 'center', 
                padding: '40px 20px',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center'
              }}>
                <div style={{ 
                  width: '60px',
                  height: '60px',
                  borderRadius: '50%',
                  backgroundColor: '#f5f5f5',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '24px',
                  marginBottom: '15px'
                }}>
                  âœ‰ï¸
                </div>
                <div style={{ color: '#666', fontWeight: 'bold', marginBottom: '8px' }}>
                  ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤
                </div>
                <div style={{ color: '#999', fontSize: '14px' }}>
                  ì²« ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”! âœï¸
                </div>
              </div>
            )}
          </div>

          {/* ë©”ì‹œì§€ ì…ë ¥ */}
          <div style={{
            padding: '20px',
            borderTop: '1px solid #dee2e6',
            backgroundColor: 'white'
          }}>
            <form onSubmit={handleSendMessage} style={{ display: 'flex', gap: '10px' }}>
              <input
                type="text"
                value={newMessage}
                onChange={(e) => setNewMessage(e.target.value)}
                placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                style={{
                  flex: 1,
                  padding: '12px 16px',
                  border: '1px solid #dee2e6',
                  borderRadius: '25px',
                  fontSize: '16px',
                  outline: 'none'
                }}
              />
              <button
                type="submit"
                style={{
                  padding: '12px 24px',
                  backgroundColor: '#007bff',
                  color: 'white',
                  border: 'none',
                  borderRadius: '25px',
                  fontSize: '16px',
                  cursor: 'pointer',
                  fontWeight: 'bold'
                }}
              >
                ì „ì†¡
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  );
}

export default App;
